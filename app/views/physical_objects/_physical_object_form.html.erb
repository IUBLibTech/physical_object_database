<% @controller ||= 'physical_objects' %>
<% @tm ||= @physical_object.technical_metadatum.as_technical_metadatum %>
<%= error_messages_for(@physical_object) %>
<%= error_messages_for(@tm) %>
<%= nested_form_for(@physical_object) do |f| %>
  <div id="physicalObject" class="left">
    <h2>Physical Object</h2>
    <table>
      <tr>
        <th>Title</th>
        <td>
          <%= f.text_field(:title, readonly: !@edit_mode) %>
        </td> 
      </tr>
      <tr>
        <th>Author</th>
        <td>
          <%= f.text_field(:author, readonly: !@edit_mode) %>
        </td> 
      </tr>
      <tr>
        <th>Title control number</th>
        <td>
          <%= f.text_field(:title_control_number, readonly: !@edit_mode) %>
        </td>
      </tr>
      <tr>
        <th>Call number</th>
        <td>
          <%= f.text_field(:call_number, readonly: !@edit_mode) %>
        </td>
      </tr>
      <tr>
        <th>Catalog key</th>
        <td>
          <%= f.text_field(:catalog_key, readonly: !@edit_mode) %>
        </td>
      </tr>
      <tr>
        <th>Unit</th>
        <td>
          <%= f.collection_select :unit_id, Unit.order('abbreviation ASC'), :id, :abbreviation, {prompt: "Please specify a unit"}, disabled: !@edit_mode %>
        </td>
      </tr>
      <tr>
        <th>Home location</th>
        <td>
          <%= f.text_field(:home_location, readonly: !@edit_mode) %>
        </td>
      </tr>
      <tr>
        <th>IUCAT barcode</th>
        <td>
          <%= f.text_field(:iucat_barcode, readonly: !@edit_mode) %>
        </td>
      </tr>
      <tr>
        <th>OCLC number</th>
        <td>
          <%= f.text_field(:oclc_number, readonly: !@edit_mode) %>
        </td>
      </tr>
      <tr>
        <th>Format</th>
        <td>
          <%= f.select(:format, PhysicalObject.formats, {},	disabled: !@edit_mode, :onChange => "tm_div(this.value, 'PhysicalObject', #{@physical_object.id.nil? ? 0 : @physical_object.id}, #{@edit_mode})")  %>    
        </td>
      </tr>
      <tr>
        <th>Other copies</th>
        <td>
          <% if @edit_mode %>
            <%= f.check_box(:other_copies) %>
          <% else %>
            <input type="text" name="other_copies" value=<%= @physical_object.other_copies ? "true" : "false" %> readonly />
          <% end %>
        </td>
      </tr>
      <tr>
        <th>Group key</th>
	<td>
	  <% if !@group_key.nil? %>
	    <%= link_to(@group_key.group_identifier, group_key_path(@group_key.id)) %>
	  <% else %>
	    Not assigned
	  <% end %>
          <% if @edit_mode %>
            <%= @group_key.nil? ? "<br/>Assign to: ".html_safe : "<br/>Reassign to: ".html_safe %>
            <%= f.collection_select :group_key_id, GroupKey.order('id ASC'), :id, :group_identifier, {include_blank: 'New Group Key'} %>
          <% end %>
	</td>
      </tr>
      <tr>
        <th>Group position</th>
	<td>
	  <%= f.number_field(:group_position, readonly: !@edit_mode, min: 1, max: @group_key.nil? ? 1 : @group_key.group_total + 1) %>
	</td>
      </tr>
      <tr>
        <th>Carrier stream index</th>
        <td>
          <%= @physical_object.carrier_stream_index %>
        </td>
      </tr>
      <tr>
        <th>Collection identifier</th>
        <td>
          <%= f.text_field(:collection_identifier, readonly: !@edit_mode) %>
        </td>
      </tr>
      <tr>
        <th>Collection name</th>
        <td>
          <%= f.text_field(:collection_name, readonly: !@edit_mode) %>
        </td>
      </tr>
      <tr>
        <th>Year</th>
        <td>
          <%= f.text_field(:year, readonly: !@edit_mode) %>
        </td>
      </tr>
      
      <tr>
        <th>MDPI barcode</th>
        <td>
          <%= f.text_field(:mdpi_barcode, readonly: !@edit_mode, class: "mdpi") %>
        </td>
      </tr>
      <tr>
        <th>Generation</th>
        <td>
          <%= f.select(:generation, @physical_object.generation_values, {}, disabled:!@edit_mode) %>
        </td>
      </tr>
      <tr>
        <th>Has ephemera</th>
        <td>
          <% if @edit_mode %>
            <%= f.check_box(:has_ephemera) %>
          <% else %>
            <input type="text" name="has_ephemera" value=<%= @physical_object.has_ephemera ? "true" : "false" %> readonly />
          <% end %>
        </td>
      </tr>
      <tr>
        <th>Imported from spreadsheet</th>
        <td>
          <% if !@physical_object.spreadsheet.nil? %>
            <%= link_to("#{@physical_object.spreadsheet.filename}", @physical_object.spreadsheet) %>
          <% end %>
        </td>
      </tr>
      <tr>
	<th>Created</th>
        <td>
          <%= f.text_field(:created_at, readonly: true) %>
        </td>
      </tr>
      <tr>
        <th>Updated</th>
        <td>
          <%= f.text_field(:updated_at, readonly: true) %>
        </td>
      </tr>
      <%= render 'workflow_status_templates/current_workflow_status', f: f, target_object: @physical_object %>
    </table> 
    <% if @display_assigned %>
      <div id="assigned_to_div">
        <table>
	  <tr>
	    <th colspan="2">Assignment</th>
	  </tr>
          <tr>
            <th>Picklist</th>
            <td>
              <% if !@physical_object.picklist.nil? %>
                <%= link_to(@physical_object.picklist.name, controller: 'picklists', action: 'show', id: @physical_object.picklist.id ) %>
              <% else %>
                Not Assigned
              <% end %>
              <% if @edit_mode %>
                <%= @physical_object.picklist.nil? ? "<br/>Assign to: ".html_safe : "<br/>Reassign to: ".html_safe %>
                <%= f.collection_select :picklist_id, Picklist.order('name ASC'), :id, :name, {include_blank: 'None'} %>
              <% end %>
            </td>
          </tr>
          <tr>
            <th>Bin/Box</th>
            <td>
              <% if !@physical_object.bin.nil? %>
                <%= link_to("Bin: #{@physical_object.bin.identifier}", @physical_object.bin) %>
              <% elsif !@physical_object.box.nil? %>
                <%= link_to("Box: #{@physical_object.box.mdpi_barcode}", @physical_object.box) %>
              <% else %>
                Not Assigned
              <% end %>
            </td>
          </tr>
          <tr>
            <th>Batch</th>
            <td>
              <% p = @physical_object %>
              <% name = nil %>
              <% bid = nil %>
              <% if !p.bin.nil? and !p.bin.batch.nil? %>
                <% name = p.bin.batch.identifier %>
                <% bid = p.bin.batch.id %>
              <% elsif !p.box.nil? and !p.box.bin.nil? and !p.box.bin.batch.nil?%>
                <% name = p.box.bin.batch.identifier %>
                <% bid = p.box.bin.batch.id %>
              <% end %>
              <% if !name.nil? %>
                <%= link_to(name, controller: :batches, action: :show, id: bid) %>
              <% else %>
                Not Assigned
              <% end %>
            </td>
          </tr>
        </table>
      </div>
    <% end %>
    <div id="condition_statuses_div">
      <%= f.fields_for :condition_statuses do |condition| %>
        <%= render 'condition_status_templates/condition_status_fields', f: condition, target_object: @physical_object %>
      <% end %>
      <% if @edit_mode %>
        <%= f.link_to_add "Add a condition status", :condition_statuses %>
      <% end %>
    </div>
    <div id="notes_div">
      <%= f.fields_for :notes do |note| %>
        <%= render 'notes/note_fields', f: note%>
      <% end %>
      <% if @edit_mode %>
        <%= f.link_to_add "Add a note", :notes %>
      <% end %>
    </div>
  </div>

  
  <div id="technicalMetadatum" class="left">
    <%= render(:partial => tm_partial_path(@tm)) %>
  </div>

  <div class="left">
    <h2>Digital Files</h2>
    <% unless @digital_files.nil? %>
      <% @digital_files.each do |files| %>
        <%= render(partial: 'media_files/media_file_form', locals: {f: files}) %>
      <% end %>
    <% end %>
  </div>
  <%# add the submit and close off the form_for %>
  <%if @edit_mode or @action == 'destroy' %>
    <div class="clear" ><%= submit_tag(@submit_text) %></div>
  <% end %>
<% end %>
