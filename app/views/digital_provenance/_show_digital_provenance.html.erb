<div class="left">
	<%= nested_form_for(@dp, url: {controller: 'digital_provenance', action: 'update'}) do |dp| %>
		<div>
			<h2>Digital Provenance</h2>
				<% if @edit_mode %>
					<%= dp.submit "Update Digital Provenance" %>
				<% end %>
			<%= dp.hidden_field :digitizing_entity, value: "IU Media Digitization Studios" %>
			<table>
				<tr>
					<th rowspan="4">Comments<%= dp_requirement(:comments) %></th>
					<td rowspan="4">
						<%= dp.text_area(:comments, rows: "6", readonly: !@edit_mode, disabled: dp_na(:comments)) %>
					</td>
					<th rowspan="4">Cleaning Comment<%= dp_requirement(:cleaning_comment) %></th>
					<td rowspan="4">
						<%= dp.text_area(:cleaning_comment, rows: "6", readonly: !@edit_mode, disabled: dp_na(:cleaning_comment)) %>
					</td>
					<th>Cleaning Date<%= dp_requirement(:cleaning_date) %></th>
					<td>
						<%= dp.text_field(:cleaning_date, readonly: !@edit_mode, class: @edit_mode ? "date" : "", value: @dp.cleaning_date.blank? ? "" : @dp.cleaning_date.in_time_zone("UTC").strftime("%m/%d/%Y"), disabled: dp_na(:cleaning_date)) %>
					</td>
				</tr>
				<tr>
					<th>Baking Date<%= dp_requirement(:baking_date) %></th>
					<td>
						<%= dp.text_field(:baking, readonly: !@edit_mode, class: @edit_mode ? "date" : "", value: @dp.baking.blank? ? "" : @dp.baking.in_time_zone("UTC").strftime("%m/%d/%Y"), disabled: dp_na(:baking_date)) %>
					</td>
				</tr>
				<tr>
					<th>Repaired<%= dp_requirement(:repaired) %></th>
					<td>
						<%= dp.check_box(:repaired, readonly: !@edit_mode || dp_na(:repaired)) %>
					</td>
				</tr>
				<tr>
					<th>Digitization Time (in minutes)<%= dp_requirement(:duration) %></th>
					<td>
						<% if @edit_mode %>
						  <%= dp.number_field(:duration, readonly: !@edit_mode, disabled: dp_na(:duration)) %>
						<% else %>
						  <%= dp.text_field(:duration, readonly: !@edit_mode, disabled: dp_na(:duration)) %>
						<% end %>
					</td>
				</tr>
				<tr>
					<th>Batch Processing Flag<%= dp_requirement(:batch_processing_flag) %></th>
					<td colspan="5">
						<%= dp.text_field(:batch_processing_flag, readonly: !@edit_mode, disabled: dp_na(:batch_processing_flag)) %>
					</td>
				</tr>
			</table>				
		</div>
		<%# the fields for kluge %>
		<% dp.fields_for :physical_object do |df| %>
		<% end %>
		<div id="file_holder">
			<h2>Digital Files</h2>
			<% if @dp.digital_file_provenances.size == 0 and !@edit_mode %>
				Digital files have not been received yet...
			<% else %>
				<%= dp.fields_for :digital_file_provenances do |df| %>
					<%= render 'digital_provenance/digital_file_provenance', f: df, dp: dp %>
				<% end %>
			<% end %>
	    <% if @edit_mode && policy(@dp).edit? %>
	      <%= dp.link_to_add "Add Digital File", :digital_file_provenances, :data => { :target => "#file_holder" } if policy(@dp).edit? %>
	    <% end %>
		</div>
	<% end %>
	<div class="clear">
		<h2>Digital Statuses</h2>
	</div>

	<script type='text/javascript'>
		$(function (){
			$('.date').datepicker();
		});
		$(document).on('nested:fieldAdded', function(event){
			var ext = <%= (TechnicalMetadatumModule.tm_genres[@physical_object.format] == :audio ? "'wav'" : "'mkv'").html_safe%>;
			// the "Add Digital File/PrestInt" link
			var trig = event.currentTarget.activeElement;
			el = $('.filename').last();
			var v = "mmm";
			if ( el.val().length == 0) {
				bc = $("#barcode").first().text();
				if (trig.text == "Add Digital File") {
					seq = ("000" + ($('.filename').size())).slice(-2);
					v = "MDPI_"+bc+"_"+seq+"_pres."+ext;
				} else {
					masterFilename = event.currentTarget.activeElement.parentNode.parentNode.parentNode.children[1].children[1].children[0].value;
					pattern = "_[0-9]{2}_";
					seq = masterFilename.substring(masterFilename.search(pattern)+1, masterFilename.search(pattern)+3);
					v = "MDPI_"+bc+"_"+seq+"_presInt."+ext;
					//remove the "add presInt" link
					$(".presInt").last().empty();

					//copy over all values from the master file.
					srcComment = ($(trig)).closest('.digiprov').find('td > textarea').val();
					$('.digiprov').last().find('td > textarea').val(srcComment);
//					for (x = 4; x <12; x++) {
//						val = ($(trig)).closest('.digiprov').find('td > input')[x].value;
//						$('.digiprov').last().find('td > input')[x].value = val;
//					}
					$('.digiprov').last().find('th').addClass('presInt');
				}
				el.val(v);
			}
		})
	</script>
</div>
